# ä¼ä¸šçº§å¤šé“¾é’±åŒ…ç³»ç»Ÿ - æŠ€æœ¯é‡ç‚¹åŠè®¾è®¡æ–‡æ¡£

**ç‰ˆæœ¬**: v2.1.0
**ç¼–å†™æ—¥æœŸ**: 2025-11-10
**ä½œè€…**: Aitachi
**é‚®ç®±**: 44158892@qq.com

---

## ğŸ“‹ æ–‡æ¡£æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†é˜è¿°ä¼ä¸šçº§å¤šé“¾é’±åŒ…ç³»ç»Ÿçš„æŠ€æœ¯æ¶æ„ã€æ ¸å¿ƒè®¾è®¡ã€å®‰å…¨æ–¹æ¡ˆå’Œå®ç°ç»†èŠ‚ã€‚é¢å‘æŠ€æœ¯å›¢é˜Ÿï¼Œç”¨äºæŒ‡å¯¼ç³»ç»Ÿå¼€å‘ã€éƒ¨ç½²å’Œç»´æŠ¤ã€‚

---

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

### æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        å®¢æˆ·ç«¯å±‚                              â”‚
â”‚         Web Portal | Mobile App | API Clients              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚ HTTPS/TLS 1.3
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      APIç½‘å…³å±‚                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚JWTè®¤è¯   â”‚  â”‚é€Ÿç‡é™åˆ¶  â”‚  â”‚å®‰å…¨å“åº”å¤´â”‚  â”‚CORSæ§åˆ¶ â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æ ¸å¿ƒæœåŠ¡å±‚ (Rust)                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚   é’±åŒ…æœåŠ¡       â”‚  â”‚   æç°æœåŠ¡      â”‚  â”‚  å……å€¼æœåŠ¡   â”‚â”‚
â”‚  â”‚ - åœ°å€ç”Ÿæˆ       â”‚  â”‚ - å®¡æ‰¹æµç¨‹      â”‚  â”‚ - é“¾ç›‘å¬    â”‚â”‚
â”‚  â”‚ - ä½™é¢æŸ¥è¯¢       â”‚  â”‚ - äº¤æ˜“æ„å»º      â”‚  â”‚ - åœ°å€æ±     â”‚â”‚
â”‚  â”‚ - å†·çƒ­åˆ†å±‚       â”‚  â”‚ - ç­¾åå¹¿æ’­      â”‚  â”‚ - ç¡®è®¤æœºåˆ¶  â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚   é£æ§å¼•æ“       â”‚  â”‚   å®¡è®¡æœåŠ¡      â”‚  â”‚  å¯†é’¥ç®¡ç†   â”‚â”‚
â”‚  â”‚ - é»‘åå•         â”‚  â”‚ - æ“ä½œæ—¥å¿—      â”‚  â”‚ - AWS KMS   â”‚â”‚
â”‚  â”‚ - é™é¢ç®¡ç†       â”‚  â”‚ - èµ„äº§è¿½è¸ª      â”‚  â”‚ - ä¿¡å°åŠ å¯†  â”‚â”‚
â”‚  â”‚ - å¼‚å¸¸æ£€æµ‹       â”‚  â”‚ - åˆè§„æŠ¥å‘Š      â”‚  â”‚ - å¯†é’¥è½®æ¢  â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚  â”‚   ä»»åŠ¡è°ƒåº¦       â”‚  â”‚  DeFi/NFTé›†æˆ   â”‚                  â”‚
â”‚  â”‚ - è‡ªåŠ¨å½’é›†       â”‚  â”‚ - Swap/Lending  â”‚                  â”‚
â”‚  â”‚ - ä½™é¢é¢„è­¦       â”‚  â”‚ - NFTç®¡ç†       â”‚                  â”‚
â”‚  â”‚ - å¯¹è´¦ä»»åŠ¡       â”‚  â”‚ - ä»£å¸ç®¡ç†      â”‚                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      æ•°æ®å­˜å‚¨å±‚                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚PostgreSQLâ”‚  â”‚  Redis   â”‚  â”‚  Kafka   â”‚  â”‚  MinIO   â”‚   â”‚
â”‚  â”‚ ä¸šåŠ¡æ•°æ®  â”‚  â”‚  ç¼“å­˜    â”‚  â”‚ æ¶ˆæ¯é˜Ÿåˆ— â”‚  â”‚ æ–‡ä»¶å­˜å‚¨ â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                â”‚
â”‚  â”‚ AWS KMS  â”‚  â”‚AWS S3    â”‚                                â”‚
â”‚  â”‚ å¯†é’¥ç®¡ç†  â”‚  â”‚ å¤‡ä»½å­˜å‚¨ â”‚                                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     åŒºå—é“¾é€‚é…å±‚                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Solana   â”‚  â”‚ Ethereum â”‚  â”‚   BSC    â”‚  â”‚ Polygon  â”‚   â”‚
â”‚  â”‚ Adapter  â”‚  â”‚ Adapter  â”‚  â”‚ Adapter  â”‚  â”‚ Adapter  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚ RPC/WebSocket
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      åŒºå—é“¾ç½‘ç»œ                              â”‚
â”‚    Solana Mainnet | Ethereum Mainnet | BSC | Polygon       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”‘ æ ¸å¿ƒæŠ€æœ¯è®¾è®¡

### 1. å¯†é’¥ç®¡ç†æ¶æ„

#### 1.1 ä¿¡å°åŠ å¯†(Envelope Encryption)

```rust
/**
 * ä¿¡å°åŠ å¯†å®ç°
 * Author: Aitachi
 * Email: 44158892@qq.com
 */

// æ­¥éª¤1: ä»AWS KMSç”Ÿæˆæ•°æ®å¯†é’¥
let (plaintext_data_key, encrypted_data_key) = kms_client
    .generate_data_key()
    .key_id("alias/wallet-master-key")
    .key_spec(KeySpec::Aes256)
    .send()
    .await?;

// æ­¥éª¤2: ä½¿ç”¨æ•°æ®å¯†é’¥åŠ å¯†ç§é’¥
let cipher = Aes256Gcm::new(GenericArray::from_slice(&plaintext_data_key));
let nonce = Aes256Gcm::generate_nonce(&mut OsRng);
let ciphertext = cipher.encrypt(&nonce, private_key.as_bytes())?;

// æ­¥éª¤3: å­˜å‚¨åŠ å¯†åçš„æ•°æ®å¯†é’¥å’Œå¯†æ–‡
db.save(WalletKey {
    encrypted_data_key,  // KMSåŠ å¯†çš„æ•°æ®å¯†é’¥
    ciphertext,          // æ•°æ®å¯†é’¥åŠ å¯†çš„ç§é’¥
    nonce,               // åŠ å¯†nonce
});

// è§£å¯†æµç¨‹
let plaintext_data_key = kms_client
    .decrypt()
    .ciphertext_blob(Blob::new(encrypted_data_key))
    .send()
    .await?;

let cipher = Aes256Gcm::new(GenericArray::from_slice(&plaintext_data_key));
let private_key = cipher.decrypt(&nonce, ciphertext.as_ref())?;
```

**ä¼˜åŠ¿**:
- KMSä¸»å¯†é’¥ä»ä¸ç¦»å¼€HSM
- æ”¯æŒå¯†é’¥è½®æ¢
- å®¡è®¡æ‰€æœ‰å¯†é’¥æ“ä½œ
- ç¬¦åˆé‡‘èè¡Œä¸šæ ‡å‡†

#### 1.2 HDé’±åŒ…(BIP32/BIP44)

```
Master Seed (256 bit)
    â†“ PBKDF2
Master Private Key
    â†“ BIP32 Derivation
m/44'/coin_type'/account'/change/address_index

ç¤ºä¾‹:
- Ethereum: m/44'/60'/0'/0/0
- Solana: m/44'/501'/0'/0'
- Bitcoin: m/44'/0'/0'/0/0
```

**å®ç°**:
```rust
/**
 * HDé’±åŒ…æ´¾ç”Ÿ
 * Author: Aitachi
 * Email: 44158892@qq.com
 */
use bip32::{ExtendedPrivateKey, DerivationPath};

// ä»ä¸»å¯†é’¥æ´¾ç”Ÿå­å¯†é’¥
let master_key = ExtendedPrivateKey::from_seed(&seed)?;
let derivation_path = DerivationPath::from_str("m/44'/60'/0'/0/0")?;
let child_key = master_key.derive_path(&derivation_path)?;

// ç”Ÿæˆåœ°å€
let public_key = child_key.public_key();
let address = ethereum_address_from_pubkey(&public_key);
```

---

### 2. è®¤è¯æˆæƒç³»ç»Ÿ

#### 2.1 JWTæ¶æ„

```rust
/**
 * JWT Claimsç»“æ„
 * Author: Aitachi
 * Email: 44158892@qq.com
 */
#[derive(Debug, Serialize, Deserialize)]
pub struct Claims {
    pub sub: String,              // ç”¨æˆ·ID
    pub role: String,             // è§’è‰²(admin/operator/viewer)
    pub permissions: Vec<String>, // ç»†ç²’åº¦æƒé™
    pub exp: usize,               // è¿‡æœŸæ—¶é—´(Unix timestamp)
    pub iat: usize,               // ç­¾å‘æ—¶é—´
    pub session_id: String,       // ä¼šè¯ID(æ”¯æŒä¸»åŠ¨å¤±æ•ˆ)
    pub ip: String,               // ç­¾å‘IP
    pub device_id: String,        // è®¾å¤‡ID
}

// Tokenç”Ÿæˆ
pub fn generate_token(&self, user_id: &str, role: &str) -> Result<String> {
    let claims = Claims {
        sub: user_id.to_string(),
        role: role.to_string(),
        permissions: self.get_permissions(role),
        exp: (Utc::now() + Duration::hours(1)).timestamp() as usize,
        iat: Utc::now().timestamp() as usize,
        session_id: Uuid::new_v4().to_string(),
        ip: current_ip,
        device_id: device_fingerprint,
    };

    encode(&Header::default(), &claims, &self.encoding_key)
}
```

#### 2.2 RBACæƒé™æ¨¡å‹

```yaml
Roles:
  admin:
    - wallet:*
    - withdrawal:*
    - user:*
    - system:*

  operator:
    - wallet:read
    - wallet:create
    - withdrawal:approve
    - withdrawal:reject

  viewer:
    - wallet:read
    - withdrawal:read
    - audit:read

  api_user:
    - wallet:read
    - wallet:create
    - withdrawal:create

Permission Check:
  if user.role == "admin" || user.permissions.contains(required_permission) {
      allow
  } else {
      deny
  }
```

---

### 3. é€Ÿç‡é™åˆ¶ç®—æ³•

#### 3.1 ä»¤ç‰Œæ¡¶ç®—æ³•(Token Bucket)

```rust
/**
 * å¤šçº§é€Ÿç‡é™åˆ¶å™¨
 * Author: Aitachi
 * Email: 44158892@qq.com
 */
pub struct MultiLevelRateLimiter {
    redis: Arc<RedisClient>,
}

impl MultiLevelRateLimiter {
    // IPçº§åˆ«é™åˆ¶: æ»‘åŠ¨çª—å£ + ä»¤ç‰Œæ¡¶
    pub async fn check_ip_limit(&self, ip: &str) -> Result<bool> {
        let key = format!("rate_limit:ip:{}", ip);
        let window = 3600; // 1å°æ—¶
        let limit = 1000;  // 1000è¯·æ±‚

        // æ»‘åŠ¨çª—å£è®¡æ•°
        let now = Utc::now().timestamp();
        let count: i64 = self.redis
            .zcount(&key, now - window, now)
            .await?;

        if count >= limit {
            return Ok(false);
        }

        // æ·»åŠ å½“å‰è¯·æ±‚
        self.redis.zadd(&key, now, Uuid::new_v4().to_string()).await?;
        self.redis.expire(&key, window).await?;

        Ok(true)
    }

    // ç”¨æˆ·çº§åˆ«é™åˆ¶: æ›´é«˜çš„é™åˆ¶
    pub async fn check_user_limit(&self, user_id: &str) -> Result<bool> {
        // 5000 req/hour
        self.check_limit(&format!("user:{}", user_id), 3600, 5000).await
    }

    // æ“ä½œçº§åˆ«é™åˆ¶: æç°æ¯å¤©10æ¬¡
    pub async fn check_operation_limit(
        &self,
        user_id: &str,
        operation: &str
    ) -> Result<bool> {
        let limit = match operation {
            "withdrawal" => (86400, 10),     // 10/day
            "wallet_create" => (86400, 100), // 100/day
            _ => (3600, 1000),               // default 1000/hour
        };

        self.check_limit(
            &format!("op:{}:{}", user_id, operation),
            limit.0,
            limit.1
        ).await
    }
}
```

**ç®—æ³•ç‰¹ç‚¹**:
- **å¹³æ»‘é™æµ**: é¿å…çªå‘æµé‡
- **å¤šçº§æ§åˆ¶**: IP/ç”¨æˆ·/æ“ä½œä¸‰çº§
- **åˆ†å¸ƒå¼**: åŸºäºRedisï¼Œæ”¯æŒé›†ç¾¤
- **ä½å»¶è¿Ÿ**: å•æ¬¡æ£€æŸ¥ < 5ms

---

### 4. åŒºå—é“¾é€‚é…å™¨è®¾è®¡

#### 4.1 ç»Ÿä¸€æ¥å£æŠ½è±¡

```rust
/**
 * åŒºå—é“¾é€‚é…å™¨ç»Ÿä¸€æ¥å£
 * Author: Aitachi
 * Email: 44158892@qq.com
 */
#[async_trait]
pub trait BlockchainAdapter: Send + Sync {
    // åœ°å€ç”Ÿæˆ
    async fn generate_address(&self, derivation_path: &str) -> Result<Address>;

    // åœ°å€éªŒè¯
    fn validate_address(&self, address: &str) -> bool;

    // ä½™é¢æŸ¥è¯¢
    async fn get_balance(&self, address: &str) -> Result<Balance>;

    // äº¤æ˜“æ„å»º
    async fn build_transfer(
        &self,
        from: &str,
        to: &str,
        amount: u64,
        token: Option<&str>
    ) -> Result<UnsignedTransaction>;

    // äº¤æ˜“ç­¾å
    async fn sign_transaction(
        &self,
        unsigned_tx: &UnsignedTransaction,
        private_key: &[u8]
    ) -> Result<SignedTransaction>;

    // äº¤æ˜“å¹¿æ’­
    async fn broadcast(&self, signed_tx: &SignedTransaction) -> Result<String>;

    // äº¤æ˜“æŸ¥è¯¢
    async fn get_transaction(&self, tx_hash: &str) -> Result<Transaction>;

    // Gasä¼°ç®—
    async fn estimate_gas(&self, tx: &UnsignedTransaction) -> Result<u64>;
}
```

#### 4.2 Solanaå®ç°ç¤ºä¾‹

```rust
/**
 * Solanaé€‚é…å™¨å®ç°
 * Author: Aitachi
 * Email: 44158892@qq.com
 */
pub struct SolanaAdapter {
    rpc_client: RpcClient,
    commitment: CommitmentConfig,
}

#[async_trait]
impl BlockchainAdapter for SolanaAdapter {
    async fn generate_address(&self, derivation_path: &str) -> Result<Address> {
        let keypair = self.derive_keypair(derivation_path)?;

        Ok(Address {
            address: keypair.pubkey().to_string(),
            derivation_path: derivation_path.to_string(),
            chain: "solana".to_string(),
        })
    }

    async fn get_balance(&self, address: &str) -> Result<Balance> {
        let pubkey = Pubkey::from_str(address)?;
        let lamports = self.rpc_client
            .get_balance_with_commitment(&pubkey, self.commitment)
            .await?
            .value;

        // æŸ¥è¯¢SPLä»£å¸ä½™é¢
        let token_accounts = self.rpc_client
            .get_token_accounts_by_owner(&pubkey, TokenAccountsFilter::ProgramId(spl_token::id()))
            .await?;

        Ok(Balance {
            total: lamports,
            available: lamports,
            tokens: self.parse_token_accounts(token_accounts),
        })
    }

    async fn build_transfer(
        &self,
        from: &str,
        to: &str,
        amount: u64,
        token: Option<&str>
    ) -> Result<UnsignedTransaction> {
        let from_pubkey = Pubkey::from_str(from)?;
        let to_pubkey = Pubkey::from_str(to)?;

        let instruction = if let Some(token_address) = token {
            // SPLä»£å¸è½¬è´¦
            self.build_token_transfer(from, to, token_address, amount)?
        } else {
            // SOLè½¬è´¦
            system_instruction::transfer(&from_pubkey, &to_pubkey, amount)
        };

        let recent_blockhash = self.rpc_client.get_latest_blockhash().await?;

        let message = Message::new_with_blockhash(
            &[instruction],
            Some(&from_pubkey),
            &recent_blockhash,
        );

        Ok(UnsignedTransaction {
            message: message.serialize(),
            chain: "solana".to_string(),
        })
    }
}
```

---

### 5. é£æ§å¼•æ“è®¾è®¡

#### 5.1 å®æ—¶é£æ§æµç¨‹

```
æç°è¯·æ±‚
    â†“
1. é»‘åå•æ£€æŸ¥ (Redisç¼“å­˜ + PostgreSQL)
    â”œâ”€ åœ°å€é»‘åå•
    â”œâ”€ IPé»‘åå•
    â””â”€ ç”¨æˆ·é»‘åå•
    â†“
2. é™é¢æ£€æŸ¥
    â”œâ”€ å•ç¬”é™é¢
    â”œâ”€ æ—¥é™é¢
    â””â”€ æœˆé™é¢
    â†“
3. å¼‚å¸¸è¡Œä¸ºæ£€æµ‹
    â”œâ”€ é«˜é¢‘æ£€æµ‹(10åˆ†é’Ÿå†…>5ç¬”)
    â”œâ”€ å¤§é¢å¼‚å¸¸(>3Ïƒ)
    â”œâ”€ åœ°å€è·³è·ƒ(é¢‘ç¹æ¢åœ°å€)
    â””â”€ æ—¶é—´å¼‚å¸¸(å‡Œæ™¨2-5ç‚¹)
    â†“
4. é£é™©è¯„åˆ†
    score = Î£(risk_factor * weight)
    â†“
5. å†³ç­–
    â”œâ”€ score < 30  â†’ è‡ªåŠ¨é€šè¿‡
    â”œâ”€ 30 â‰¤ score < 60 â†’ äººå·¥å®¡æ ¸
    â””â”€ score â‰¥ 60  â†’ è‡ªåŠ¨æ‹’ç»
```

#### 5.2 å¼‚å¸¸æ£€æµ‹ç®—æ³•

```rust
/**
 * å¼‚å¸¸æ£€æµ‹å¼•æ“
 * Author: Aitachi
 * Email: 44158892@qq.com
 */
pub struct AnomalyDetector {
    db: Arc<Database>,
    redis: Arc<RedisClient>,
}

impl AnomalyDetector {
    // æ£€æµ‹é«˜é¢‘äº¤æ˜“
    pub async fn detect_high_frequency(&self, user_id: &str) -> Result<bool> {
        let key = format!("withdrawal:freq:{}", user_id);
        let count: i64 = self.redis.incr(&key).await?;

        if count == 1 {
            self.redis.expire(&key, 600).await?; // 10åˆ†é’Ÿ
        }

        Ok(count > 5)
    }

    // æ£€æµ‹å¤§é¢å¼‚å¸¸(3-sigmaè§„åˆ™)
    pub async fn detect_large_amount(&self, user_id: &str, amount: u64) -> Result<bool> {
        // è·å–ç”¨æˆ·å†å²äº¤æ˜“
        let history = self.db
            .get_withdrawal_history(user_id, 30) // æœ€è¿‘30å¤©
            .await?;

        if history.len() < 3 {
            return Ok(false); // æ ·æœ¬ä¸è¶³
        }

        // è®¡ç®—å‡å€¼å’Œæ ‡å‡†å·®
        let mean = history.iter().map(|tx| tx.amount).sum::<u64>() / history.len() as u64;
        let variance = history.iter()
            .map(|tx| {
                let diff = tx.amount as i64 - mean as i64;
                (diff * diff) as u64
            })
            .sum::<u64>() / history.len() as u64;
        let std_dev = (variance as f64).sqrt();

        // 3-sigmaæ£€æµ‹
        let z_score = ((amount as f64 - mean as f64) / std_dev).abs();
        Ok(z_score > 3.0)
    }

    // æ£€æµ‹åœ°å€è·³è·ƒ
    pub async fn detect_address_hopping(&self, user_id: &str) -> Result<bool> {
        let recent = self.db
            .get_recent_withdrawal_addresses(user_id, 10)
            .await?;

        // å¦‚æœæœ€è¿‘10ç¬”æç°æœ‰8ä¸ªä»¥ä¸Šä¸åŒåœ°å€ï¼Œæ ‡è®°å¼‚å¸¸
        let unique_addresses: HashSet<_> = recent.into_iter().collect();
        Ok(unique_addresses.len() > 8)
    }

    // ç»¼åˆé£é™©è¯„åˆ†
    pub async fn calculate_risk_score(
        &self,
        withdrawal: &WithdrawalRequest
    ) -> Result<u32> {
        let mut score = 0u32;

        // é»‘åå•æ£€æŸ¥(50åˆ†)
        if self.is_blacklisted(&withdrawal.to_address).await? {
            score += 50;
        }

        // å¤§é¢å¼‚å¸¸(20åˆ†)
        if self.detect_large_amount(&withdrawal.user_id, withdrawal.amount).await? {
            score += 20;
        }

        // é«˜é¢‘äº¤æ˜“(15åˆ†)
        if self.detect_high_frequency(&withdrawal.user_id).await? {
            score += 15;
        }

        // æ—¶é—´å¼‚å¸¸(10åˆ†)
        let hour = Utc::now().hour();
        if hour >= 2 && hour < 5 && withdrawal.amount > 10_000_000_000 {
            score += 10;
        }

        // IPå¼‚å¸¸(5åˆ†)
        if withdrawal.ip != withdrawal.user_last_login_ip {
            score += 5;
        }

        Ok(score)
    }
}
```

---

### 6. å……å€¼ç›‘å¬æ¶æ„

#### 6.1 è½®è¯¢æ¨¡å¼

```rust
/**
 * åŒºå—é“¾å……å€¼ç›‘å¬å™¨
 * Author: Aitachi
 * Email: 44158892@qq.com
 */
pub struct DepositMonitor {
    adapter: Arc<dyn BlockchainAdapter>,
    db: Arc<Database>,
    last_block: AtomicU64,
}

impl DepositMonitor {
    pub async fn start(&self) -> Result<()> {
        loop {
            // è·å–æœ€æ–°åŒºå—
            let latest_block = self.adapter.get_latest_block_number().await?;
            let last_processed = self.last_block.load(Ordering::SeqCst);

            // å¤„ç†æ–°åŒºå—
            for block_num in (last_processed + 1)..=latest_block {
                self.process_block(block_num).await?;
                self.last_block.store(block_num, Ordering::SeqCst);
            }

            // ä¼‘çœ 5ç§’
            tokio::time::sleep(Duration::from_secs(5)).await;
        }
    }

    async fn process_block(&self, block_num: u64) -> Result<()> {
        let block = self.adapter.get_block(block_num).await?;

        for tx in block.transactions {
            // æ£€æŸ¥æ˜¯å¦æ˜¯å……å€¼äº¤æ˜“
            if self.is_deposit_transaction(&tx).await? {
                self.handle_deposit(&tx).await?;
            }
        }

        Ok(())
    }

    async fn is_deposit_transaction(&self, tx: &Transaction) -> Result<bool> {
        // æ£€æŸ¥æ¥æ”¶åœ°å€æ˜¯å¦åœ¨æˆ‘ä»¬çš„åœ°å€æ± ä¸­
        self.db.is_our_address(&tx.to).await
    }

    async fn handle_deposit(&self, tx: &Transaction) -> Result<()> {
        // è·å–ç¡®è®¤æ•°
        let confirmations = self.adapter.get_confirmations(&tx.hash).await?;

        let required_confirmations = match tx.chain.as_str() {
            "solana" => 32,
            "ethereum" => 12,
            "bsc" => 15,
            _ => 12,
        };

        let status = if confirmations >= required_confirmations {
            DepositStatus::Confirmed
        } else {
            DepositStatus::Pending
        };

        // ä¿å­˜åˆ°æ•°æ®åº“
        self.db.save_deposit(Deposit {
            tx_hash: tx.hash.clone(),
            from_address: tx.from.clone(),
            to_address: tx.to.clone(),
            amount: tx.amount,
            confirmations,
            status,
            chain: tx.chain.clone(),
        }).await?;

        // å¦‚æœå·²ç¡®è®¤ï¼Œæ›´æ–°ç”¨æˆ·ä½™é¢
        if status == DepositStatus::Confirmed {
            self.update_user_balance(&tx).await?;
            self.send_notification(&tx).await?;
        }

        Ok(())
    }
}
```

#### 6.2 WebSocketæ¨¡å¼(Solana)

```rust
/**
 * Solana WebSocketç›‘å¬
 * Author: Aitachi
 * Email: 44158892@qq.com
 */
pub async fn subscribe_account_changes(
    addresses: Vec<String>
) -> Result<()> {
    let ws_url = "wss://api.mainnet-beta.solana.com";
    let (ws_stream, _) = connect_async(ws_url).await?;
    let (mut write, mut read) = ws_stream.split();

    // è®¢é˜…åœ°å€å˜åŠ¨
    for address in addresses {
        let subscribe_msg = json!({
            "jsonrpc": "2.0",
            "id": 1,
            "method": "accountSubscribe",
            "params": [
                address,
                {
                    "encoding": "jsonParsed",
                    "commitment": "finalized"
                }
            ]
        });

        write.send(Message::Text(subscribe_msg.to_string())).await?;
    }

    // å¤„ç†æ¶ˆæ¯
    while let Some(msg) = read.next().await {
        match msg? {
            Message::Text(text) => {
                let notification: Notification = serde_json::from_str(&text)?;
                handle_account_change(notification).await?;
            }
            _ => {}
        }
    }

    Ok(())
}
```

---

### 7. æ•°æ®åº“è®¾è®¡

#### 7.1 æ ¸å¿ƒè¡¨ç»“æ„

```sql
-- é’±åŒ…è¡¨
CREATE TABLE wallets (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    address VARCHAR(255) NOT NULL UNIQUE,
    chain VARCHAR(50) NOT NULL,
    wallet_type VARCHAR(20) NOT NULL, -- hot/warm/cold
    derivation_path VARCHAR(255),
    encrypted_data_key BYTEA NOT NULL,
    ciphertext BYTEA NOT NULL,
    nonce BYTEA NOT NULL,
    label VARCHAR(255),
    created_at TIMESTAMP NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP NOT NULL DEFAULT NOW(),

    INDEX idx_chain_type (chain, wallet_type),
    INDEX idx_address (address)
);

-- æç°è¡¨
CREATE TABLE withdrawals (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id VARCHAR(255) NOT NULL,
    from_wallet_id UUID NOT NULL REFERENCES wallets(id),
    to_address VARCHAR(255) NOT NULL,
    amount NUMERIC(36, 0) NOT NULL,
    token_address VARCHAR(255),
    chain VARCHAR(50) NOT NULL,
    status VARCHAR(20) NOT NULL, -- pending/approved/processing/completed/failed/rejected
    tx_hash VARCHAR(255),
    gas_used NUMERIC(36, 0),
    mfa_verified BOOLEAN DEFAULT false,
    risk_score INTEGER,
    approved_by VARCHAR(255),
    approved_at TIMESTAMP,
    created_at TIMESTAMP NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP NOT NULL DEFAULT NOW(),

    INDEX idx_user (user_id),
    INDEX idx_status (status),
    INDEX idx_created (created_at DESC)
);

-- å……å€¼è¡¨
CREATE TABLE deposits (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tx_hash VARCHAR(255) NOT NULL UNIQUE,
    from_address VARCHAR(255) NOT NULL,
    to_wallet_id UUID NOT NULL REFERENCES wallets(id),
    amount NUMERIC(36, 0) NOT NULL,
    token_address VARCHAR(255),
    chain VARCHAR(50) NOT NULL,
    confirmations INTEGER NOT NULL DEFAULT 0,
    status VARCHAR(20) NOT NULL, -- pending/confirmed/failed
    block_number BIGINT,
    user_id VARCHAR(255),
    created_at TIMESTAMP NOT NULL DEFAULT NOW(),
    confirmed_at TIMESTAMP,

    INDEX idx_tx_hash (tx_hash),
    INDEX idx_user (user_id),
    INDEX idx_status_chain (status, chain)
);

-- å®¡è®¡æ—¥å¿—è¡¨
CREATE TABLE audit_logs (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id VARCHAR(255),
    action VARCHAR(100) NOT NULL,
    resource_type VARCHAR(50),
    resource_id VARCHAR(255),
    ip_address INET,
    user_agent TEXT,
    request_params JSONB,
    response_status INTEGER,
    error_message TEXT,
    signature VARCHAR(255), -- HMACç­¾å
    created_at TIMESTAMP NOT NULL DEFAULT NOW(),

    INDEX idx_user_action (user_id, action),
    INDEX idx_created (created_at DESC)
);

-- é£æ§é»‘åå•è¡¨
CREATE TABLE risk_blacklist (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    address VARCHAR(255) NOT NULL,
    chain VARCHAR(50) NOT NULL,
    reason TEXT,
    source VARCHAR(100), -- Chainalysis/TRM/Manual
    added_by VARCHAR(255),
    created_at TIMESTAMP NOT NULL DEFAULT NOW(),

    UNIQUE (address, chain),
    INDEX idx_address (address)
);
```

#### 7.2 æ€§èƒ½ä¼˜åŒ–

**åˆ†åŒºè¡¨(Partitioning)**
```sql
-- æŒ‰æœˆåˆ†åŒºå®¡è®¡æ—¥å¿—
CREATE TABLE audit_logs_2025_11 PARTITION OF audit_logs
    FOR VALUES FROM ('2025-11-01') TO ('2025-12-01');

CREATE TABLE audit_logs_2025_12 PARTITION OF audit_logs
    FOR VALUES FROM ('2025-12-01') TO ('2026-01-01');
```

**ç´¢å¼•ä¼˜åŒ–**
```sql
-- å¤åˆç´¢å¼•
CREATE INDEX idx_withdrawals_user_status_created
    ON withdrawals(user_id, status, created_at DESC);

-- éƒ¨åˆ†ç´¢å¼•(ä»…ç´¢å¼•æœªå®Œæˆçš„æç°)
CREATE INDEX idx_pending_withdrawals
    ON withdrawals(created_at DESC)
    WHERE status IN ('pending', 'approved', 'processing');
```

---

### 8. ç¼“å­˜ç­–ç•¥

#### 8.1 å¤šçº§ç¼“å­˜

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  åº”ç”¨å†…å­˜ç¼“å­˜   â”‚  TTL: 10s, çƒ­ç‚¹æ•°æ®(ä½™é¢)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“ Miss
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Redisç¼“å­˜      â”‚  TTL: 60s, å¸¸ç”¨æŸ¥è¯¢
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“ Miss
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PostgreSQL     â”‚  æŒä¹…åŒ–æ•°æ®
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 8.2 Redisæ•°æ®ç»“æ„

```rust
/**
 * Redisç¼“å­˜ç®¡ç†
 * Author: Aitachi
 * Email: 44158892@qq.com
 */

// ä½™é¢ç¼“å­˜ (String)
Key: balance:{chain}:{address}
Value: {"total": 1000000000, "available": 900000000}
TTL: 30ç§’

// é€Ÿç‡é™åˆ¶ (Sorted Set)
Key: rate_limit:ip:{ip}
Members: timestamp
Score: timestamp
TTL: 3600ç§’

// å……å€¼åœ°å€æ±  (Set)
Key: address_pool:{chain}
Members: [address1, address2, ...]

// é»‘åå•ç¼“å­˜ (Hash)
Key: blacklist:addresses
Fields: {address: reason}
TTL: 3600ç§’

// Sessionç®¡ç† (String)
Key: session:{session_id}
Value: {"user_id": "...", "expires": ...}
TTL: 3600ç§’
```

---

### 9. éƒ¨ç½²æ¶æ„

#### 9.1 ç”Ÿäº§ç¯å¢ƒæ‹“æ‰‘

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   Cloudflare â”‚
                    â”‚   CDN + WAF  â”‚
                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  Load Balancerâ”‚
                    â”‚   (ALB/NLB)   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                  â”‚                  â”‚
   â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”
   â”‚ API Node 1â”‚      â”‚ API Node 2â”‚      â”‚ API Node 3â”‚
   â”‚  (Rust)   â”‚      â”‚  (Rust)   â”‚      â”‚  (Rust)   â”‚
   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
        â”‚                  â”‚                  â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                  â”‚                  â”‚
   â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”
   â”‚PostgreSQLâ”‚      â”‚  Redis   â”‚      â”‚  AWS KMS â”‚
   â”‚ Primary  â”‚      â”‚  Cluster â”‚      â”‚          â”‚
   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
   â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”
   â”‚PostgreSQLâ”‚
   â”‚ Replica  â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 9.2 å®¹å™¨åŒ–éƒ¨ç½²

```yaml
# docker-compose.yml
version: '3.8'

services:
  api:
    image: onchain-wallet:v2.1.0
    deploy:
      replicas: 3
      resources:
        limits:
          cpus: '2'
          memory: 2G
    environment:
      - DATABASE_URL=postgresql://...
      - REDIS_URL=redis://...
      - AWS_KMS_KEY_ID=...
    ports:
      - "8080"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  postgres:
    image: postgres:16
    volumes:
      - postgres-data:/var/lib/postgresql/data
    environment:
      - POSTGRES_PASSWORD=...

  redis:
    image: redis:7-alpine
    command: redis-server --appendonly yes
    volumes:
      - redis-data:/data
```

---

### 10. ç›‘æ§å‘Šè­¦

#### 10.1 ç›‘æ§æŒ‡æ ‡

```yaml
# Prometheusç›‘æ§æŒ‡æ ‡

# è¯·æ±‚æŒ‡æ ‡
http_requests_total{method, endpoint, status}
http_request_duration_seconds{method, endpoint}

# ä¸šåŠ¡æŒ‡æ ‡
withdrawal_total{chain, status}
deposit_total{chain, status}
wallet_balance{chain, wallet_type}

# ç³»ç»ŸæŒ‡æ ‡
process_cpu_usage
process_memory_usage
db_connections_active
redis_connections_active

# åŒºå—é“¾æŒ‡æ ‡
blockchain_latest_block{chain}
blockchain_sync_lag{chain}
```

#### 10.2 å‘Šè­¦è§„åˆ™

```yaml
# Prometheus Alert Rules

groups:
  - name: wallet_alerts
    rules:
      # APIé”™è¯¯ç‡è¿‡é«˜
      - alert: HighErrorRate
        expr: rate(http_requests_total{status=~"5.."}[5m]) > 0.05
        for: 5m
        annotations:
          summary: "APIé”™è¯¯ç‡è¶…è¿‡5%"

      # ä½™é¢ä¸è¶³
      - alert: LowBalance
        expr: wallet_balance{wallet_type="hot"} < 10000000000
        for: 1m
        annotations:
          summary: "çƒ­é’±åŒ…ä½™é¢ä¸è¶³"

      # åŒºå—é“¾åŒæ­¥å»¶è¿Ÿ
      - alert: BlockchainSyncLag
        expr: blockchain_sync_lag > 100
        for: 10m
        annotations:
          summary: "åŒºå—é“¾åŒæ­¥å»¶è¿Ÿè¶…è¿‡100ä¸ªåŒºå—"
```

---

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–æŠ€æœ¯

### 1. æ•°æ®åº“ä¼˜åŒ–
- **è¿æ¥æ± **: HikariCP, æœ€å¤§è¿æ¥æ•°50
- **æŸ¥è¯¢ä¼˜åŒ–**: ä½¿ç”¨ç´¢å¼•,é¿å…å…¨è¡¨æ‰«æ
- **è¯»å†™åˆ†ç¦»**: ä¸»åº“å†™å…¥,ä»åº“æŸ¥è¯¢
- **åˆ†åŒºè¡¨**: æŒ‰æœˆåˆ†åŒºå†å²æ•°æ®

### 2. ç¼“å­˜ä¼˜åŒ–
- **å¤šçº§ç¼“å­˜**: å†…å­˜ + Redis
- **ç¼“å­˜é¢„çƒ­**: å¯åŠ¨æ—¶åŠ è½½çƒ­ç‚¹æ•°æ®
- **ç¼“å­˜ç©¿é€**: å¸ƒéš†è¿‡æ»¤å™¨
- **ç¼“å­˜é›ªå´©**: éšæœºTTL

### 3. å¹¶å‘ä¼˜åŒ–
- **å¼‚æ­¥å¤„ç†**: Tokioå¼‚æ­¥è¿è¡Œæ—¶
- **æ‰¹é‡æ“ä½œ**: æ‰¹é‡æŸ¥è¯¢ä½™é¢
- **æ— é”æ•°æ®ç»“æ„**: Arc + AtomicU64
- **è¿æ¥å¤ç”¨**: HTTP Keep-Alive

### 4. åŒºå—é“¾ä¼˜åŒ–
- **RPCè´Ÿè½½å‡è¡¡**: å¤šä¸ªRPCèŠ‚ç‚¹è½®è¯¢
- **æ‰¹é‡æŸ¥è¯¢**: eth_batchCall
- **æœ¬åœ°èŠ‚ç‚¹**: è‡ªå»ºå½’æ¡£èŠ‚ç‚¹
- **ç¼“å­˜é“¾ä¸Šæ•°æ®**: ç¼“å­˜ä¸å¯å˜æ•°æ®(åŒºå—/äº¤æ˜“)

---

## ğŸ” å®‰å…¨åŠ å›ºæªæ–½

### 1. ç½‘ç»œå®‰å…¨
- âœ… WAFé˜²æŠ¤(Cloudflare)
- âœ… DDoSé˜²æŠ¤
- âœ… IPç™½åå•
- âœ… VPCéš”ç¦»

### 2. åº”ç”¨å®‰å…¨
- âœ… JWTè®¤è¯
- âœ… RBACæˆæƒ
- âœ… MFAäºŒæ¬¡éªŒè¯
- âœ… è¯·æ±‚ç­¾åéªŒè¯
- âœ… SQLæ³¨å…¥é˜²æŠ¤(å‚æ•°åŒ–æŸ¥è¯¢)
- âœ… XSSé˜²æŠ¤(è¾“å…¥è¿‡æ»¤)

### 3. æ•°æ®å®‰å…¨
- âœ… TLS 1.3ä¼ è¾“åŠ å¯†
- âœ… AES-256å­˜å‚¨åŠ å¯†
- âœ… æ•æ„Ÿæ•°æ®è„±æ•
- âœ… å®šæœŸå¤‡ä»½
- âœ… åŠ å¯†å¤‡ä»½

### 4. è¿ç»´å®‰å…¨
- âœ… æœ€å°æƒé™åŸåˆ™
- âœ… å®¡è®¡æ—¥å¿—
- âœ… å®‰å…¨æ‰«æ
- âœ… æ¼æ´ä¿®å¤
- âœ… å®šæœŸæ¸—é€æµ‹è¯•

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

**ä½œè€…**: Aitachi
**é‚®ç®±**: 44158892@qq.com
**é¡¹ç›®**: ä¼ä¸šçº§å¤šé“¾é’±åŒ…ç³»ç»Ÿ
**ç‰ˆæœ¬**: v2.1.0
**å®‰å…¨è¯„çº§**: B+ (89/100)

---

<div align="center">

**ä¼ä¸šçº§å¤šé“¾é’±åŒ…ç³»ç»Ÿ | æŠ€æœ¯æ–‡æ¡£**

æœ¬æ–‡æ¡£ä¸ºæŠ€æœ¯å†…éƒ¨æ–‡æ¡£ï¼Œè¯·å¦¥å–„ä¿ç®¡

Copyright Â© 2025 Aitachi. All rights reserved.

</div>
