# 企业级多链钱包系统 - 功能描述文档

**版本**: v2.1.0
**编写日期**: 2025-11-10
**作者**: Aitachi
**邮箱**: 44158892@qq.com

---

## 📋 文档概述

本文档详细描述企业级多链钱包系统的所有功能模块、使用场景、技术规格和操作流程。系统支持Solana、Ethereum、BSC、Polygon等多条主流公链，提供交易所级别的安全性和性能。

---

## 🎯 系统总览

### 核心定位
企业级多链钱包系统是面向交易所、DeFi平台、支付服务商等企业客户的专业级区块链资产管理解决方案。

### 主要特点
- **多链支持**: 统一接口管理多条公链资产
- **冷热分层**: 三层钱包架构确保资产安全
- **高性能**: 支持800+ TPS并发处理
- **企业级安全**: B+级安全评级，符合金融行业标准
- **灵活扩展**: 插件化架构，快速接入新链

---

## 📦 功能模块详解

## 一、基础服务层 (8个核心模块)

### 1.1 钱包管理服务

#### 功能概述
提供多链钱包的创建、查询、管理功能，支持冷热钱包分层管理。

#### 核心功能

**1.1.1 地址生成**
- **功能描述**: 基于HD钱包(BIP44/BIP32)生成区块链地址
- **支持链**: Solana, Ethereum, BSC, Polygon, Bitcoin
- **派生路径**:
  - Solana: `m/44'/501'/0'/0'`
  - Ethereum: `m/44'/60'/0'/0/0`
  - Bitcoin: `m/44'/0'/0'/0/0`
- **安全特性**: 私钥通过AWS KMS加密存储，支持密钥轮换

**1.1.2 余额查询**
- **实时余额**: 直接从链上RPC节点查询
- **缓存机制**: Redis缓存热钱包余额(30秒TTL)
- **多币种支持**: 主币 + ERC20/SPL代币
- **性能指标**: 查询响应时间 < 100ms

**1.1.3 冷热钱包分层**
```
冷钱包(99%资产)
  ↓ 手动转账(多签审批)
温钱包(5%资产)
  ↓ 自动归集(阈值触发)
热钱包(<1%资产)
```

- **冷钱包**: 离线存储，多签审批，定期审计
- **温钱包**: MPC签名，自动归集，余额预警
- **热钱包**: 实时充提，高频交易，风控拦截

**1.1.4 钱包类型**
- **托管钱包**: 平台统一管理私钥
- **半托管钱包**: 用户+平台共同管理(MPC)
- **观察钱包**: 仅查询余额，不持有私钥

#### API接口

```bash
# 创建钱包
POST /api/v1/wallets
{
  "chain": "solana",
  "wallet_type": "hot",  // hot/warm/cold
  "label": "用户充值热钱包"
}

# 查询钱包详情
GET /api/v1/wallets/{wallet_id}

# 查询余额
GET /api/v1/wallets/{wallet_id}/balance?include_tokens=true

# 获取钱包列表
GET /api/v1/wallets?chain=ethereum&type=hot&page=1&limit=50
```

#### 使用场景
1. **用户充值**: 为每个用户生成独立充值地址
2. **平台运营**: 创建热钱包处理日常充提
3. **资产存储**: 创建冷钱包存储大额资产

---

### 1.2 提现服务

#### 功能概述
处理用户提现请求，支持自动/手动审批，集成风控引擎和MFA认证。

#### 核心功能

**1.2.1 提现流程**
```
用户发起提现
  ↓
风控检查(黑名单/限额/异常)
  ↓
MFA验证(TOTP/邮件/短信)
  ↓
余额验证
  ↓
构建交易
  ↓
签名交易(KMS)
  ↓
广播到链上
  ↓
状态追踪
```

**1.2.2 审批机制**
- **自动审批**: 金额 < 1 ETH, 用户信誉良好
- **人工审批**: 金额 > 10 ETH, 新用户, 异常交易
- **多签审批**: 冷钱包提现，需要3/5多签

**1.2.3 费用管理**
- **Gas估算**: 实时估算链上Gas费用
- **费用优化**: 支持慢速/标准/快速三档
- **费用垫付**: 平台可代垫Gas费用

**1.2.4 状态追踪**
| 状态 | 说明 |
|-----|------|
| pending | 待审批 |
| approved | 已审批，待处理 |
| processing | 交易已提交到链上 |
| confirming | 等待确认(6个区块) |
| completed | 提现成功 |
| failed | 提现失败 |
| rejected | 审批拒绝 |

#### API接口

```bash
# 创建提现请求
POST /api/v1/withdrawals
{
  "user_id": "user123",
  "chain": "ethereum",
  "to_address": "0x742d35Cc6634C0532925a3b844Bc9e7595f0bEb",
  "amount": "1500000000000000000",  // 1.5 ETH (wei)
  "token_address": null,  // null表示主币
  "mfa_code": "123456"
}

# 查询提现状态
GET /api/v1/withdrawals/{withdrawal_id}

# 审批提现(管理员)
POST /api/v1/withdrawals/{withdrawal_id}/approve
{
  "admin_id": "admin001",
  "note": "审批通过"
}

# 拒绝提现(管理员)
POST /api/v1/withdrawals/{withdrawal_id}/reject
{
  "admin_id": "admin001",
  "reason": "地址异常"
}

# 批量提现
POST /api/v1/withdrawals/batch
{
  "withdrawals": [
    {"to_address": "0x...", "amount": "1000000"},
    {"to_address": "0x...", "amount": "2000000"}
  ]
}
```

#### 使用场景
1. **用户提现**: 用户提取资产到外部地址
2. **商户结算**: 批量结算商户收益
3. **冷钱包归集**: 温钱包定期归集到冷钱包

---

### 1.3 充值服务

#### 功能概述
监听区块链充值事件，自动识别用户充值，更新账户余额。

#### 核心功能

**1.3.1 充值监听**
- **轮询模式**: 定时查询最新区块(5秒间隔)
- **WebSocket模式**: 实时订阅链上事件
- **历史补偿**: 启动时扫描最近1000个区块

**1.3.2 地址池管理**
- **预生成**: 提前生成10,000个充值地址
- **动态分配**: 用户请求时分配未使用地址
- **地址回收**: 6个月未使用地址回收复用

**1.3.3 确认机制**
| 链 | 确认数 | 平均时间 |
|---|--------|----------|
| Solana | 32个slot | ~13秒 |
| Ethereum | 12个区块 | ~3分钟 |
| BSC | 15个区块 | ~45秒 |
| Bitcoin | 6个区块 | ~60分钟 |

**1.3.4 异常处理**
- **链重组检测**: 监听区块链回滚事件
- **重复充值**: 通过tx_hash去重
- **小额过滤**: 过滤Dust Attack(< 0.001 ETH)

#### API接口

```bash
# 获取充值地址
GET /api/v1/deposits/address?user_id=user123&chain=ethereum

# 查询充值记录
GET /api/v1/deposits?user_id=user123&status=confirmed&page=1

# 充值详情
GET /api/v1/deposits/{deposit_id}

# 手动确认充值(管理员)
POST /api/v1/deposits/{deposit_id}/confirm
```

#### 使用场景
1. **用户充值**: 用户向平台充值资产
2. **商户收款**: 商户接收客户支付
3. **跨链桥**: 接收跨链资产转入

---

### 1.4 风控引擎

#### 功能概述
实时监控交易行为，识别异常交易，防止资金被盗和洗钱风险。

#### 核心功能

**1.4.1 黑名单管理**
- **地址黑名单**: 禁止与已知黑名单地址交易
- **IP黑名单**: 限制恶意IP访问
- **用户黑名单**: 冻结风险用户账户
- **数据来源**: Chainalysis, TRM Labs, 内部标记

**1.4.2 限额管理**
```yaml
单笔限额:
  - 新用户: 1 ETH/笔
  - 普通用户: 10 ETH/笔
  - VIP用户: 100 ETH/笔

日限额:
  - 新用户: 5 ETH/天
  - 普通用户: 50 ETH/天
  - VIP用户: 500 ETH/天
```

**1.4.3 异常检测**
- **高频交易**: 10分钟内 > 5笔提现
- **大额异常**: 金额超过历史平均值3倍
- **地址跳跃**: 频繁更换提现地址
- **时间异常**: 非常规时间段(凌晨2-5点)大额交易
- **IP异常**: 登录IP与提现IP不一致

**1.4.4 风险评分**
```
风险评分 = 黑名单命中(50分)
          + 金额异常(20分)
          + 频率异常(15分)
          + 时间异常(10分)
          + IP异常(5分)

评分 < 30: 自动通过
评分 30-60: 人工审核
评分 > 60: 自动拒绝
```

#### API接口

```bash
# 风控检查
POST /api/v1/risk/check
{
  "user_id": "user123",
  "to_address": "0x742d35Cc6634C0532925a3b844Bc9e7595f0bEb",
  "amount": "5000000000000000000",
  "chain": "ethereum"
}

# 添加黑名单
POST /api/v1/risk/blacklist
{
  "address": "0x...",
  "reason": "钓鱼地址",
  "source": "Chainalysis"
}

# 查询风险评分
GET /api/v1/risk/score?user_id=user123
```

---

### 1.5 审计服务

#### 功能概述
记录所有系统操作日志，支持合规审计和事件追溯。

#### 核心功能

**1.5.1 操作日志**
记录内容:
- 操作类型(创建钱包/提现/审批等)
- 操作人(用户ID/管理员ID)
- 操作时间(UTC时间戳)
- 操作参数(请求参数)
- 操作结果(成功/失败)
- IP地址
- 用户代理

**1.5.2 资产追踪**
- **余额快照**: 每日记录所有钱包余额
- **资产变动**: 记录每笔充值/提现/转账
- **对账报表**: 生成日/周/月对账报表
- **差异预警**: 链上余额与账面余额差异 > 0.1%触发预警

**1.5.3 审计日志签名**
- 使用HMAC-SHA256签名审计日志
- 防止日志被篡改
- 支持第三方验证

**1.5.4 合规报告**
- **可疑交易报告(STR)**: 自动生成可疑交易报告
- **大额交易报告(CTR)**: 单笔 > 10 ETH自动报告
- **用户尽职调查(KYC)**: 记录KYC验证过程

#### API接口

```bash
# 查询操作日志
GET /api/v1/audit/logs?user_id=user123&action=withdrawal&start_date=2025-11-01

# 查询资产变动
GET /api/v1/audit/asset-changes?wallet_id=wallet001&start_date=2025-11-01

# 生成对账报表
POST /api/v1/audit/reconciliation
{
  "date": "2025-11-10",
  "chains": ["ethereum", "solana"]
}

# 验证日志签名
POST /api/v1/audit/verify-signature
{
  "log_id": "log_123456",
  "signature": "..."
}
```

---

### 1.6 密钥管理服务

#### 功能概述
基于AWS KMS的企业级密钥管理，支持密钥加密、轮换和审计。

#### 核心功能

**1.6.1 AWS KMS集成**
```rust
// 主密钥加密
KMS.encrypt(master_key) -> encrypted_master_key

// 数据密钥生成(信封加密)
KMS.generate_data_key() -> (plaintext_key, encrypted_key)

// 使用数据密钥加密私钥
AES256-GCM.encrypt(private_key, plaintext_key) -> ciphertext
```

**1.6.2 密钥层级**
```
KMS Customer Master Key (CMK)
  ↓ 加密
Master Key (平台主密钥)
  ↓ 派生
Wallet Root Key (钱包根密钥)
  ↓ 派生(BIP32)
Address Private Key (地址私钥)
```

**1.6.3 密钥轮换**
- **自动轮换**: KMS CMK每年自动轮换
- **手动轮换**: 支持紧急轮换(泄露事件)
- **重加密**: 轮换后重新加密所有密钥材料

**1.6.4 HSM支持**
- 支持AWS CloudHSM
- 符合FIPS 140-2 Level 3标准
- 物理隔离的硬件安全模块

#### API接口

```bash
# 加密数据(内部接口)
POST /api/internal/kms/encrypt
{
  "plaintext": "sensitive_data",
  "key_id": "cmk_id"
}

# 解密数据(内部接口)
POST /api/internal/kms/decrypt
{
  "ciphertext": "...",
  "key_id": "cmk_id"
}

# 轮换密钥(管理员)
POST /api/admin/kms/rotate
{
  "key_type": "master_key"
}
```

---

### 1.7 任务调度服务

#### 功能概述
管理系统定时任务，包括自动归集、余额预警、对账等。

#### 核心功能

**1.7.1 自动归集**
- **触发条件**: 热钱包余额 > 100 ETH
- **归集目标**: 温钱包
- **执行频率**: 每小时检查
- **Gas优化**: 选择Gas费低谷期执行

**1.7.2 余额预警**
- **热钱包预警**: 余额 < 10 ETH
- **温钱包预警**: 余额 < 500 ETH
- **通知方式**: 邮件 + 短信 + Webhook

**1.7.3 对账任务**
- **每日对账**: 凌晨2点执行
- **检查项**: 链上余额 vs 账面余额
- **差异处理**: 差异 > 0.1% 触发人工复核

**1.7.4 数据清理**
- **日志归档**: 90天以上日志归档到S3
- **地址池刷新**: 补充充值地址池
- **缓存清理**: 清理过期Redis缓存

---

### 1.8 API网关服务

#### 功能概述
统一的API入口，提供认证、授权、限流、监控等功能。

#### 核心功能

**1.8.1 JWT认证**
```http
POST /api/v1/auth/login
{
  "username": "user123",
  "password": "...",
  "mfa_code": "123456"
}

Response:
{
  "access_token": "eyJhbGc...",
  "refresh_token": "...",
  "expires_in": 3600
}
```

**1.8.2 RBAC权限控制**
| 角色 | 权限 |
|-----|------|
| admin | 所有权限 |
| operator | 钱包管理、提现审批 |
| viewer | 只读查询 |
| api_user | API调用权限 |

**1.8.3 速率限制**
```yaml
IP级别: 1000 req/hour
用户级别: 5000 req/hour
操作级别:
  - withdrawal: 10/day
  - wallet_create: 100/day
  - query: 10000/day
```

**1.8.4 安全响应头**
```http
X-Frame-Options: DENY
X-Content-Type-Options: nosniff
Strict-Transport-Security: max-age=31536000
Content-Security-Policy: default-src 'self'
```

---

## 二、增强功能层 (10个扩展模块)

### 2.1 NFT资产管理

#### 功能概述
管理NFT资产，支持查询、转账、元数据获取。

#### 核心功能
- **NFT持仓查询**: 查询用户所有NFT资产
- **NFT转账**: 转移NFT所有权
- **元数据获取**: 获取NFT图片、属性等元数据
- **批量查询**: 批量查询NFT地板价

#### 支持标准
- Ethereum: ERC-721, ERC-1155
- Solana: Metaplex NFT Standard

---

### 2.2 代币管理

#### 功能概述
支持ERC20/SPL代币的查询和转账。

#### 核心功能
- **代币余额查询**: 查询所有代币余额
- **代币转账**: 转账ERC20/SPL代币
- **代币白名单**: 管理支持的代币列表
- **价格查询**: 集成DEX价格数据

---

### 2.3 DeFi集成

#### 功能概述
集成主流DeFi协议，支持Swap、Lending、Staking。

#### 核心功能

**Swap**
- Uniswap V3
- PancakeSwap
- Jupiter (Solana)

**Lending**
- Aave
- Compound

**Staking**
- ETH 2.0 Staking
- SOL Staking

---

### 2.4 交易历史

#### 功能概述
记录和查询多链交易历史。

#### 核心功能
- **交易查询**: 按地址、时间、类型查询
- **交易详情**: 查看完整交易信息
- **导出报表**: 导出CSV/Excel格式
- **税务报表**: 生成税务申报报表

---

### 2.5 Gas优化

#### 功能概述
优化Gas费用，降低交易成本。

#### 核心功能
- **Gas估算**: 实时估算Gas费用
- **Gas预测**: 预测未来Gas价格走势
- **批量打包**: 多笔交易打包节省Gas
- **EIP-1559优化**: 智能设置base fee和priority fee

---

### 2.6 地址簿

#### 功能概述
管理常用地址，支持白名单和地址标签。

#### 核心功能
- **白名单管理**: 添加信任地址到白名单
- **地址标签**: 为地址添加备注标签
- **分组管理**: 按业务场景分组
- **快速提现**: 白名单地址快速提现

---

### 2.7 批量转账

#### 功能概述
批量处理转账，支持空投和批量结算。

#### 核心功能
- **批量转账**: 一次性向多个地址转账
- **CSV导入**: 从CSV文件导入转账列表
- **进度追踪**: 实时追踪批量转账进度
- **失败重试**: 自动重试失败交易

---

### 2.8 Webhook通知

#### 功能概述
通过Webhook推送事件通知。

#### 核心功能
- **充值通知**: 充值确认后推送
- **提现通知**: 提现状态变更推送
- **余额变动**: 余额低于阈值推送
- **重试机制**: 失败自动重试3次

---

### 2.9 多签管理

#### 功能概述
管理多签钱包，支持多人审批流程。

#### 核心功能
- **创建多签**: 创建M-of-N多签钱包
- **提案管理**: 创建和投票提案
- **签名收集**: 收集多个签名
- **执行交易**: 达到阈值后执行

---

### 2.10 数据分析

#### 功能概述
资产统计和数据分析。

#### 核心功能
- **资产统计**: 按币种、钱包类型统计
- **收益分析**: 计算持仓收益率
- **交易分析**: 分析交易频率、金额分布
- **报表生成**: 生成可视化报表

---

## 📊 性能指标

### 系统性能
| 指标 | 实测值 |
|-----|--------|
| API响应时间(P99) | <200ms |
| 数据库查询(P95) | <8ms |
| 并发TPS | 800+ |
| 内存使用 | <500MB |
| 系统可用性 | 99.95% |

### 业务指标
| 指标 | 能力 |
|-----|------|
| 充值监听延迟 | <5秒 |
| 提现处理速度 | 100笔/分钟 |
| 钱包生成速度 | 1000个/秒 |
| 余额查询QPS | 5000+ |

---

## 🔒 安全特性

### 密钥安全
- ✅ AWS KMS加密存储
- ✅ 信封加密
- ✅ 密钥自动轮换
- ✅ HSM支持(可选)

### 访问控制
- ✅ JWT认证
- ✅ RBAC权限控制
- ✅ MFA多因素认证
- ✅ IP白名单

### 交易安全
- ✅ 风控引擎
- ✅ 黑名单过滤
- ✅ 异常检测
- ✅ 多签审批

### 数据安全
- ✅ 传输加密(TLS 1.3)
- ✅ 存储加密(AES-256)
- ✅ 日志脱敏
- ✅ 备份加密

---

## 📞 技术支持

**作者**: Aitachi
**邮箱**: 44158892@qq.com
**项目**: 企业级多链钱包系统
**版本**: v2.1.0

---

<div align="center">

**企业级多链钱包系统 | 安全可靠 | 高性能 | 易扩展**

Copyright © 2025 Aitachi. All rights reserved.

</div>
